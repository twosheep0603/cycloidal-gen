// --- FreeCAD Export ---
function downloadFreeCADScript() {
	const { R, Zp, rp, e } = params;
	const scriptContent = `
# Cycloidal Gear Generator for FreeCAD
# Generated by Interactive Web Tool
# Parameters: R=${R}, Zp=${Zp}, rp=${rp}, e=${e}

import FreeCAD
import Part
import math
from FreeCAD import Base

# --- Parameters ---
R = ${R}      # Pin Circle Radius
Zp = ${Zp}    # Number of Pins
rp = ${rp}     # Pin Radius
e = ${e}      # Eccentricity
thickness = 10 # Default extrusion thickness

# Calculated
Zc = Zp - 1

# Function to calculate points
def get_cycloid_point(theta, R, Zp, e, rp):
# Epitrochoid Center
x0 = R * math.cos(theta) - e * math.cos(Zp * theta)
y0 = R * math.sin(theta) - e * math.sin(Zp * theta)

# Derivatives for Normal
dxdt = -R * math.sin(theta) + e * Zp * math.sin(Zp * theta)
dydt = R * math.cos(theta) - e * Zp * math.cos(Zp * theta)

length = math.sqrt(dxdt**2 + dydt**2)
if length == 0: return (x0, y0)

# Normal Vector (Inward)
nx = -dydt / length
ny = dxdt / length

# Offset
x = x0 + rp * nx
y = y0 + rp * ny
return FreeCAD.Vector(x, y, 0)

# Generate Points
points = []
steps = ${Zp * 60} 
for i in range(steps + 1):
theta = (float(i) / steps) * 2 * math.pi
p = get_cycloid_point(theta, R, Zp, e, rp)
points.append(p)

# Create Shape
try:
doc = FreeCAD.activeDocument()
if not doc:
	doc = FreeCAD.newDocument("CycloidGear")

# Create Wire & Solid
poly = Part.makePolygon(points)
face = Part.Face(poly)
solid = face.extrude(Base.Vector(0, 0, thickness))

# Add Cycloid Disc
obj = doc.addObject("Part::Feature", "CycloidDisk")
obj.Shape = solid

# Add Pins (Visualization Group)
pin_group = doc.addObject("App::DocumentObjectGroup", "Pins")
for i in range(Zp):
	angle = (2 * math.pi * i) / Zp
	px = R * math.cos(angle)
	py = R * math.sin(angle)
	pin = doc.addObject("Part::Cylinder", f"Pin_{i}")
	pin.Radius = rp
	pin.Height = thickness + 2
	pin.Placement.Base = Base.Vector(px, py, -1)
	pin_group.addObject(pin)

doc.recompute()
FreeCAD.Gui.SendMsgToActiveView("ViewFit")
print("Cycloid gear generated successfully!")

except Exception as err:
print(f"Error: {err}")
`;
	const blob = new Blob([scriptContent], { type: 'text/x-python' });
	const a = document.createElement('a');
	a.href = URL.createObjectURL(blob);
	a.download = `cycloid_R${R}_Zp${Zp}_e${e}.py`;
	document.body.appendChild(a);
	a.click();
	document.body.removeChild(a);
}
